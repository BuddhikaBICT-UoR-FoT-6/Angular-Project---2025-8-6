<div class="admin-page">
	<div class="page-header" style="align-items: flex-end;">
		<div class="header-content">
			<h2 class="page-title" style="margin: 0; font-size: 28px; font-weight: 700; color: var(--text);">üì¶
				Inventory Management</h2>
			<p class="page-subtitle" style="margin: 0; color: var(--muted); font-size: 14px;">Real-time stock tracking,
				restock requests, and audit logs</p>
		</div>
		<div class="inv-metrics">
			<div class="metric-card">
				<div class="metric-label">Total Items</div>
				<div class="metric-value">{{ inventory.length }}</div>
			</div>
			<div class="metric-card metric-alert">
				<div class="metric-label">‚ö†Ô∏è Low Stock</div>
				<div class="metric-value">{{ lowStock.length }}</div>
			</div>
		</div>
	</div>

	<!-- Low stock alerts -->
	<section class="alert-section" *ngIf="lowStock.length">
		<div class="alert-header">
			<h3 class="alert-title">‚ö†Ô∏è Low Stock Alerts</h3>
			<p class="alert-subtitle">Items at or below their threshold - action required</p>
		</div>
		<div class="alert-grid">
			<div class="alert-card" *ngFor="let item of lowStock">
				<div class="alert-product">{{ item.product.name || item.product._id }}</div>
				<div class="alert-sizes">
					<span class="size-badge" *ngFor="let s of item.low">
						{{ s.size }}: {{ s.stock }}/{{ s.threshold }}
					</span>
				</div>
			</div>
		</div>
	</section>

	<!-- Inventory list -->
	<section class="inventory-section">
		<div class="section-header">
			<h3 class="section-title">Inventory Items</h3>
			<p class="section-subtitle">Click any item to manage stock, create restock requests, or adjust inventory</p>
		</div>

		<div class="inventory-grid" *ngIf="inventory.length; else emptyInventory">
			<div class="inventory-card" *ngFor="let invItem of inventory" (click)="pick(invItem)"
				[class.selected]="selected?._id === invItem._id">
				<div class="card-header-inv">
					<div class="product-name">{{ productName(invItem) }}</div>
					<div class="supplier-badge" *ngIf="invItem.supplier">{{ invItem.supplier }}</div>
				</div>
				<div class="stock-grid">
					<div class="stock-item">
						<div class="stock-size">S</div>
						<div class="stock-count">{{ invItem.stock_by_size.S }}</div>
					</div>
					<div class="stock-item">
						<div class="stock-size">M</div>
						<div class="stock-count">{{ invItem.stock_by_size.M }}</div>
					</div>
					<div class="stock-item">
						<div class="stock-size">L</div>
						<div class="stock-count">{{ invItem.stock_by_size.L }}</div>
					</div>
					<div class="stock-item">
						<div class="stock-size">XL</div>
						<div class="stock-count">{{ invItem.stock_by_size.XL }}</div>
					</div>
				</div>
				<div class="card-footer" *ngIf="invItem.updated_at">
					<span class="last-updated">Updated: {{ invItem.updated_at | date : 'short' }}</span>
				</div>
			</div>
		</div>
		<ng-template #emptyInventory>
			<div class="empty-state">
				<div class="empty-icon">üì¶</div>
				<p class="empty-text">No inventory items found</p>
			</div>
		</ng-template>
	</section>
</div>

<!-- Centered Modal Overlay -->
<div class="modal-overlay" *ngIf="manageOpen && selected" (click)="closeManage()" role="presentation">
	<div class="modal-dialog" role="dialog" aria-modal="true" (click)="$event.stopPropagation()">
		<div class="modal-header">
			<div class="modal-header-content">
				<h3 class="modal-title">üì¶ Manage Inventory</h3>
				<p class="modal-subtitle">
					{{ productName(selected!) }}
					<span *ngIf="selected.supplier_email" class="supplier-email">‚Ä¢ {{ selected.supplier_email }}</span>
				</p>
			</div>
			<button type="button" class="modal-close" (click)="closeManage()" aria-label="Close">√ó</button>
		</div>

		<div class="modal-body">
			<div class="modal-sections">
				<!-- Current Stock -->
				<div class="modal-section">
					<h4 class="section-heading">üìä Current Stock</h4>
					<div class="stock-display">
						<div class="stock-display-item">
							<span class="size-label">S</span>
							<span class="size-value">{{ selected!.stock_by_size.S }}</span>
						</div>
						<div class="stock-display-item">
							<span class="size-label">M</span>
							<span class="size-value">{{ selected!.stock_by_size.M }}</span>
						</div>
						<div class="stock-display-item">
							<span class="size-label">L</span>
							<span class="size-value">{{ selected!.stock_by_size.L }}</span>
						</div>
						<div class="stock-display-item">
							<span class="size-label">XL</span>
							<span class="size-value">{{ selected!.stock_by_size.XL }}</span>
						</div>
					</div>
				</div>

				<!-- Restock Request -->
				<div class="modal-section">
					<h4 class="section-heading">üöö Create Supplier Order</h4>
					<div class="form-group-row">
						<div class="form-field">
							<label class="field-label">S</label>
							<input type="number" class="field-input" [(ngModel)]="restock.S" min="0" />
						</div>
						<div class="form-field">
							<label class="field-label">M</label>
							<input type="number" class="field-input" [(ngModel)]="restock.M" min="0" />
						</div>
						<div class="form-field">
							<label class="field-label">L</label>
							<input type="number" class="field-input" [(ngModel)]="restock.L" min="0" />
						</div>
						<div class="form-field">
							<label class="field-label">XL</label>
							<input type="number" class="field-input" [(ngModel)]="restock.XL" min="0" />
						</div>
					</div>
					<div class="form-field">
						<label class="field-label">Supplier Name</label>
						<input type="text" class="field-input" [(ngModel)]="restockSupplier" placeholder="Optional" />
					</div>
					<div class="form-field">
						<label class="field-label">Supplier Email</label>
						<input type="email" class="field-input" [(ngModel)]="restockSupplierEmail"
							placeholder="Used for notifications" />
					</div>
					<label class="field-label">Note</label>
					<input type="text" class="field-input" [(ngModel)]="restockNote" placeholder="Optional note" />
				</div>
				<div class="form-field">
					<label class="field-label">Select Supplier (Optional)</label>
					<select class="field-input" (change)="onSupplierChange($event)">
						<option value="">-- Choose from List --</option>
						<option *ngFor="let s of suppliers" [value]="s._id">{{ s.name }}</option>
					</select>
				</div>
				<button type="button" class="btn-primary" (click)="submitRestock()" [disabled]="loading">
					<span *ngIf="!loading">üìß Send Supplier Order</span>
					<span *ngIf="loading" class="spinner"></span>
				</button>
				<p class="info-message" *ngIf="requestMessage">{{ requestMessage }}</p>
			</div>

			<!-- Manual Adjustment -->
			<div class="modal-section">
				<h4 class="section-heading">‚öñÔ∏è Manual Adjustment</h4>
				<p class="section-note">Use positive/negative numbers to adjust stock (e.g., -5 for damaged items)</p>
				<div class="form-group-row">
					<div class="form-field">
						<label class="field-label">S</label>
						<input type="number" class="field-input" [(ngModel)]="adjustDelta.S" />
					</div>
					<div class="form-field">
						<label class="field-label">M</label>
						<input type="number" class="field-input" [(ngModel)]="adjustDelta.M" />
					</div>
					<div class="form-field">
						<label class="field-label">L</label>
						<input type="number" class="field-input" [(ngModel)]="adjustDelta.L" />
					</div>
					<div class="form-field">
						<label class="field-label">XL</label>
						<input type="number" class="field-input" [(ngModel)]="adjustDelta.XL" />
					</div>
				</div>
				<div class="form-field">
					<label class="field-label">Reason (Required)</label>
					<input type="text" class="field-input" [(ngModel)]="adjustReason"
						placeholder="e.g., Damaged items, Return, etc." />
				</div>
				<button type="button" class="btn-secondary" (click)="submitAdjust()" [disabled]="loading">
					‚úÖ Apply Adjustment
				</button>
			</div>

			<div class="box history">
				<div class="history-head">
					<h4>Supplier Orders (Restock Requests)</h4>
					<div class="muted">Status becomes ‚ÄúFULFILLED‚Äù only after code scan</div>
				</div>
				<div class="table-wrap" *ngIf="restockOrders.length; else emptyOrders">
					<table class="table">
						<thead>
							<tr>
								<th>Created</th>
								<th>Status</th>
								<th>Expires</th>
								<th>Qty (S/M/L/XL)</th>
								<th>Supplier</th>
								<th></th>
							</tr>
						</thead>
						<tbody>
							<tr *ngFor="let r of restockOrders">
								<td>{{ r.created_at ? (r.created_at | date : 'short') : '-' }}</td>
								<td>{{ orderStatus(r) }}</td>
								<td>{{ r.expires_at ? (r.expires_at | date : 'short') : '-' }}</td>
								<td>
									{{ r.requested_by_size.S }} /
									{{ r.requested_by_size.M }} /
									{{ r.requested_by_size.L }} /
									{{ r.requested_by_size.XL }}
								</td>
								<td>{{ r.supplier_email }}</td>
								<td>
									<button type="button" *ngIf="orderStatus(r) === 'PENDING'" (click)="cancelOrder(r)"
										[disabled]="loading">
										Cancel
									</button>
								</td>
							</tr>
						</tbody>
					</table>
				</div>
				<ng-template #emptyOrders>
					<div class="hint">No supplier orders yet for this product.</div>
				</ng-template>
			</div>
		</div>

		<div class="box history">
			<div class="history-head">
				<h4>üìú Inventory History / Audit Log</h4>
				<p class="section-subtitle">Newest first</p>
			</div>
			<div class="data-table-container" *ngIf="history.length; else emptyHistory">
				<table class="data-table">
					<thead>
						<tr>
							<th>When</th>
							<th>Action</th>
							<th>Delta</th>
							<th>Reason / Note</th>
							<th>By</th>
						</tr>
					</thead>
					<tbody>
						<tr *ngFor="let h of history">
							<td>{{ h.created_at ? (h.created_at | date : 'short') : '-' }}</td>
							<td>
								<span class="action-badge" [ngClass]="{
									'action-restock': h.action === 'RESTOCK',
										'action-adjust': h.action === 'ADJUST'
									}">
									{{ h.action }}
								</span>
							</td>
							<td>
								<div class="size-breakdown">
									<span>S: {{h.delta_by_size.S}}</span>
									<span>M: {{h.delta_by_size.M}}</span>
									<span>L: {{h.delta_by_size.L}}</span>
									<span>XL: {{h.delta_by_size.XL}}</span>
								</div>
							</td>
							<td>{{ h.reason || '-' }}</td>
							<td>
								<span class="role-badge">
									{{ h.performed_by?.role || '-' }}
								</span>
							</td>
						</tr>
					</tbody>
				</table>
			</div>
			<ng-template #emptyHistory>
				<div class="empty-state-small">
					<p>üìù No history yet.</p>
				</div>
			</ng-template>
		</div>
	</div>
</div>